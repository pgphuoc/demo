<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype | Phần mềm KCS & Hóa nghiệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Odoo-like style overrides */
        .tab-button.active {
            border-color: #714B67; /* Odoo primary purple */
            color: #714B67;
        }
        .btn-primary {
            background-color: #714B67;
            color: white;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #5a3b52;
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
             border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
             background-color: #e5e7eb;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-[#714B67]">Phần mềm Quản lý KCS & Hóa nghiệm</h1>
            <p class="text-gray-500 mt-1">Prototype Giao diện & Chức năng</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="changeTab('tab-criteria')" class="tab-button active text-sm sm:text-base whitespace-nowrap border-b-2 font-semibold px-4 py-3 text-gray-600 hover:text-[#714B67]">
                    <i class="fas fa-tasks mr-2"></i> Quản lý Tiêu chí
                </button>
                <button onclick="changeTab('tab-templates')" class="tab-button text-sm sm:text-base whitespace-nowrap border-b-2 font-semibold px-4 py-3 text-gray-600 hover:text-[#714B67] border-transparent">
                    <i class="fas fa-file-alt mr-2"></i> Quản lý Mẫu Báo cáo
                </button>
                <button onclick="changeTab('tab-reports')" class="tab-button text-sm sm:text-base whitespace-nowrap border-b-2 font-semibold px-4 py-3 text-gray-600 hover:text-[#714B67] border-transparent">
                    <i class="fas fa-edit mr-2"></i> Tạo Báo cáo
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Tab 1: Quản lý Tiêu chí -->
            <div id="tab-criteria" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Danh sách Tiêu chí Đánh giá</h2>
                        <button onclick="openModal('modal-criteria')" class="w-full sm:w-auto btn-primary flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Thêm Tiêu chí mới
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Tên Tiêu chí</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Đơn vị</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Loại Giá trị</th>
                                    <th class="py-3 px-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="criteria-table-body" class="divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Quản lý Mẫu Báo cáo -->
            <div id="tab-templates" class="tab-content hidden">
                 <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Danh sách Mẫu Báo cáo</h2>
                        <button onclick="openModal('modal-template')" class="w-full sm:w-auto btn-primary flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Tạo Mẫu mới
                        </button>
                    </div>
                    <div id="template-list" class="space-y-4">
                       <!-- Template list will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Tab 3: Tạo Báo cáo -->
            <div id="tab-reports" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg space-y-8">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">1. Thông tin chung</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4">
                            <div>
                                <label for="report-template-select" class="block text-sm font-medium text-gray-700">Mẫu báo cáo</label>
                                <select id="report-template-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-[#714B67] focus:border-[#714B67] sm:text-sm rounded-md">
                                    <option>Vui lòng chọn một mẫu...</option>
                                </select>
                            </div>
                            <div>
                                <label for="report-executor" class="block text-sm font-medium text-gray-700">Người thực hiện</label>
                                <input type="text" id="report-executor" class="mt-1 focus:ring-[#714B67] focus:border-[#714B67] block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Nguyễn Văn A">
                            </div>
                            <div>
                                <label for="report-department" class="block text-sm font-medium text-gray-700">Bộ phận yêu cầu</label>
                                <input type="text" id="report-department" class="mt-1 focus:ring-[#714B67] focus:border-[#714B67] block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Phòng Sản xuất">
                            </div>
                            <div>
                                <label for="report-requester" class="block text-sm font-medium text-gray-700">Người yêu cầu</label>
                                <input type="text" id="report-requester" class="mt-1 focus:ring-[#714B67] focus:border-[#714B67] block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Trần Thị B">
                            </div>
                             <div class="md:col-span-2">
                                <label for="report-purpose" class="block text-sm font-medium text-gray-700">Mục đích</label>
                                <input type="text" id="report-purpose" class="mt-1 focus:ring-[#714B67] focus:border-[#714B67] block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Kiểm tra chất lượng lô hàng XYZ">
                            </div>
                        </div>
                    </div>
                    
                    <div id="report-details-section" class="hidden">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">2. Kết quả Phân tích</h2>
                        <div class="overflow-x-auto relative mt-4">
                           <table class="min-w-full bg-white border text-sm">
                                <thead id="report-matrix-head" class="bg-gray-50">
                                    <!-- Header will be populated by JS -->
                                </thead>
                                <tbody id="report-matrix-body" class="divide-y divide-gray-200">
                                    <!-- Rows will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <button onclick="addSampleRow()" class="mt-4 btn-secondary flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm Mẫu
                        </button>
                    </div>

                    <div id="report-materials-section" class="hidden">
                         <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-3">3. Vật tư sử dụng</h2>
                         <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white border text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-3/5">Tên Vật tư</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/5">Số lượng</th>
                                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/5"></th>
                                    </tr>
                                </thead>
                                <tbody id="materials-body">
                                    <!-- Material rows will be populated by JS -->
                                </tbody>
                            </table>
                         </div>
                         <button onclick="addMaterialRow()" class="mt-4 btn-secondary flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm Vật tư
                        </button>
                    </div>

                    <div id="report-actions-section" class="hidden text-right space-x-3 pt-6 border-t">
                         <button class="btn-primary">
                            <i class="fas fa-save mr-2"></i> Lưu Báo cáo
                        </button>
                         <button class="btn-secondary">
                            <i class="fas fa-file-pdf mr-2"></i> Xuất PDF
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-criteria" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900" id="criteria-modal-title">Thêm Tiêu chí mới</h3>
                <button onclick="closeModal('modal-criteria')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                 <div>
                    <label for="criteria-name" class="block text-sm font-medium text-gray-700">Tên tiêu chí</label>
                    <input type="text" id="criteria-name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="criteria-unit" class="block text-sm font-medium text-gray-700">Đơn vị</label>
                    <input type="text" id="criteria-unit" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="criteria-reference" class="block text-sm font-medium text-gray-700">Tiêu chuẩn tham chiếu</label>
                    <input type="text" id="criteria-reference" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="criteria-method" class="block text-sm font-medium text-gray-700">Phương pháp thực hiện</label>
                    <input type="text" id="criteria-method" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="criteria-value-type" class="block text-sm font-medium text-gray-700">Loại giá trị kết quả</label>
                    <select id="criteria-value-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 sm:text-sm rounded-md">
                        <option value="text">Văn bản (Text)</option>
                        <option value="pass/fail">Đạt/Không đạt</option>
                        <option value="numeric">Chỉ số (Numeric)</option>
                    </select>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                 <button onclick="closeModal('modal-criteria')" class="btn-secondary">Hủy</button>
                 <button onclick="saveCriteria()" class="btn-primary">Lưu</button>
            </div>
        </div>
    </div>
    
    <div id="modal-template" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900" id="template-modal-title">Tạo Mẫu Báo cáo mới</h3>
                <button onclick="closeModal('modal-template')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                 <div>
                    <label for="template-name" class="block text-sm font-medium text-gray-700">Tên mẫu báo cáo</label>
                    <input type="text" id="template-name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Chọn các tiêu chí</label>
                    <div id="template-criteria-list" class="mt-2 h-64 overflow-y-auto border border-gray-300 rounded-md p-2 space-y-2">
                         <!-- Criteria checkboxes will be populated by JS -->
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                 <button onclick="closeModal('modal-template')" class="btn-secondary">Hủy</button>
                 <button onclick="saveTemplate()" class="btn-primary">Lưu Mẫu</button>
            </div>
        </div>
    </div>


<script>
    // --- DATABASE (In-memory simulation) ---
    let criteria = [
        // Hóa sinh
        { id: 1, name: 'PROTEIN', unit: '%', reference: 'TCVN 4328-1:2007', method: 'Phương pháp Kjeldahl', valueType: 'numeric' },
        { id: 2, name: 'SALT', unit: '%', reference: 'TCVN 3706-90', method: 'Phương pháp Mohr', valueType: 'numeric' },
        { id: 3, name: 'TVN', unit: 'mg/100g', reference: 'TCVN 3708-90', method: 'Phương pháp Conway', valueType: 'numeric' },
        { id: 4, name: 'MOIST.', unit: '%', reference: 'TCVN 4326:2001', method: 'Sấy ở 103±2°C', valueType: 'numeric' },
        { id: 5, name: 'FAT', unit: '%', reference: 'TCVN 4331:2001', method: 'Phương pháp Soxhlet', valueType: 'numeric' },
        { id: 6, name: 'ASH', unit: '%', reference: 'TCVN 4327:2007', method: 'Nung ở 550°C', valueType: 'numeric' },
        { id: 7, name: 'AV', unit: 'mgKOH/g', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 8, name: 'FFA', unit: '%', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 9, name: 'N', unit: '%', reference: 'TCVN 8562:2010', method: 'Phương pháp Kjeldahl', valueType: 'numeric' },
        { id: 10, name: 'P2O5', unit: '%', reference: 'TCVN 8563:2010', method: 'Quang phổ', valueType: 'numeric' },
        { id: 11, name: 'K2O', unit: '%', reference: 'TCVN 8564:2010', method: 'Quang kế ngọn lửa', valueType: 'numeric' },
        { id: 12, name: 'SAPO', unit: '%', reference: 'ISO 3657:2013', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 13, name: 'Độ đục', unit: 'NTU', reference: 'TCVN 6663-1:2000', method: 'Máy đo độ đục', valueType: 'numeric' },
        { id: 14, name: 'DD', unit: '%', reference: 'Internal Method', method: 'Thiết bị đo chuyên dụng', valueType: 'numeric' },
        { id: 15, name: 'Độ nhớt', unit: 'mpas', reference: 'ASTM D2196', method: 'Nhớt kế Brookfield', valueType: 'numeric' },
        { id: 16, name: 'Độ tan', unit: '%', reference: 'Internal Method', method: 'Hòa tan và lọc', valueType: 'numeric' },
        { id: 17, name: 'COD', unit: 'mg/l', reference: 'TCVN 6491:1999', method: 'Phương pháp COD', valueType: 'numeric' },
        { id: 18, name: 'PERO', unit: 'meq/kg', reference: 'TCVN 6121:2010', method: 'Chuẩn độ I-ốt', valueType: 'numeric' },
        { id: 19, name: 'SV', unit: 'mgKOH/g', reference: 'ISO 3657:2013', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 20, name: 'AV/mẫu', unit: 'mgKOH/g', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 21, name: 'FFA/mẫu', unit: '%', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 22, name: 'AV/béo', unit: 'mgKOH/g', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 23, name: 'FFA/béo', unit: '%', reference: 'TCVN 6127:2010', method: 'Chuẩn độ', valueType: 'numeric' },
        { id: 24, name: 'XƠ', unit: '%', reference: 'TCVN 1540:2007', method: 'Phương pháp Ankom', valueType: 'numeric' },
        { id: 25, name: 'SAPO ko chiết béo', unit: '%', reference: 'Internal Method', method: 'Chuẩn độ', valueType: 'numeric' },
        // Cảm quan
        { id: 26, name: 'Màu sắc', unit: '', reference: 'Internal Method', method: 'Cảm quan', valueType: 'text' },
        { id: 27, name: 'Mùi vị', unit: '', reference: 'Internal Method', method: 'Cảm quan', valueType: 'text' },
        { id: 28, name: 'Độ đồng đều', unit: '', reference: 'Internal Method', method: 'Cảm quan', valueType: 'text' },
        { id: 29, name: 'Khác (sâu mọt, tạp vật…)', unit: '', reference: 'Internal Method', method: 'Cảm quan', valueType: 'text' }
    ];
    let templates = [
        { id: 1, name: 'Báo cáo Hoá sinh Nguyên liệu', criteriaIds: [1, 4, 5, 6, 7, 8, 24] },
        { id: 2, name: 'Báo cáo Cảm quan Sản phẩm', criteriaIds: [26, 27, 28, 29] },
        { id: 3, name: 'Báo cáo Phân tích Nước thải', criteriaIds: [13, 17] },
        { id: 4, name: 'Báo cáo Hoá sinh Toàn diện', criteriaIds: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25] }
    ];

    // --- UTILITY FUNCTIONS ---
    function changeTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
            button.classList.add('border-transparent');
        });
        event.currentTarget.classList.add('active');
        event.currentTarget.classList.remove('border-transparent');
    }
    function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
    function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

    // --- CRITERIA MANAGEMENT ---
    function renderCriteriaTable() {
        const tableBody = document.getElementById('criteria-table-body');
        tableBody.innerHTML = '';
        criteria.forEach(c => {
            const valueTypeMap = {'text': 'Văn bản', 'pass/fail': 'Đạt/Không đạt', 'numeric': 'Chỉ số'};
            const row = `
                <tr class="hover:bg-gray-50">
                    <td class="py-4 px-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${c.name}</div><div class="text-xs text-gray-500">${c.reference} | ${c.method}</div></td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${c.unit}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">${valueTypeMap[c.valueType]}</span></td>
                    <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button class="text-gray-400 hover:text-[#714B67]"><i class="fas fa-pencil-alt"></i></button>
                        <button class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            tableBody.innerHTML += row;
        });
    }

    function saveCriteria() {
        const newCriteria = {
            id: criteria.length + 1,
            name: document.getElementById('criteria-name').value,
            unit: document.getElementById('criteria-unit').value,
            reference: document.getElementById('criteria-reference').value,
            method: document.getElementById('criteria-method').value,
            valueType: document.getElementById('criteria-value-type').value
        };
        criteria.push(newCriteria);
        renderCriteriaTable();
        closeModal('modal-criteria');
        document.getElementById('criteria-name').value = '';
        document.getElementById('criteria-unit').value = '';
        document.getElementById('criteria-reference').value = '';
        document.getElementById('criteria-method').value = '';
    }
    
    // --- TEMPLATE MANAGEMENT ---
    function populateCriteriaForTemplateModal() {
        const container = document.getElementById('template-criteria-list');
        container.innerHTML = '';
        criteria.forEach(c => {
            container.innerHTML += `<div class="flex items-center"><input id="crit-${c.id}" name="criteriaSelection" type="checkbox" value="${c.id}" class="h-4 w-4 text-[#714B67] border-gray-300 rounded focus:ring-[#714B67]"><label for="crit-${c.id}" class="ml-3 block text-sm text-gray-700">${c.name}</label></div>`;
        });
    }

    function renderTemplates() {
        const list = document.getElementById('template-list');
        const select = document.getElementById('report-template-select');
        list.innerHTML = '';
        select.innerHTML = '<option value="">Vui lòng chọn một mẫu...</option>';

        templates.forEach(t => {
            const templateCriteria = t.criteriaIds.map(id => criteria.find(c => c.id === id).name);
            const card = `<div class="border rounded-lg p-4 hover:shadow-md transition-shadow bg-white"><div class="flex justify-between items-center"><h3 class="font-semibold text-lg text-gray-800">${t.name}</h3><div class="text-sm space-x-2"><button class="text-gray-400 hover:text-[#714B67]"><i class="fas fa-pencil-alt"></i></button><button class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div></div><p class="text-sm text-gray-500 mt-2">Gồm các tiêu chí: ${templateCriteria.join(', ')}</p></div>`;
            list.innerHTML += card;
            select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
    }
    
    function saveTemplate() {
        const name = document.getElementById('template-name').value;
        const selectedIds = Array.from(document.querySelectorAll('input[name="criteriaSelection"]:checked')).map(cb => parseInt(cb.value));
        if (name && selectedIds.length > 0) {
            templates.push({id: templates.length + 1, name: name, criteriaIds: selectedIds});
            renderTemplates();
            closeModal('modal-template');
            document.getElementById('template-name').value = '';
        } else {
            alert('Vui lòng nhập tên mẫu và chọn ít nhất một tiêu chí.');
        }
    }

    // --- REPORT CREATION ---
    document.getElementById('report-template-select').addEventListener('change', function() {
        const templateId = parseInt(this.value);
        if (!templateId) {
            document.getElementById('report-details-section').classList.add('hidden');
            document.getElementById('report-materials-section').classList.add('hidden');
            document.getElementById('report-actions-section').classList.add('hidden');
            return;
        }
        const template = templates.find(t => t.id === templateId);
        if (template) {
            generateReportMatrix(template);
            document.getElementById('report-details-section').classList.remove('hidden');
            document.getElementById('report-materials-section').classList.remove('hidden');
            document.getElementById('report-actions-section').classList.remove('hidden');
        }
    });

    function generateReportMatrix(template) {
        const head = document.getElementById('report-matrix-head');
        const templateCriteria = template.criteriaIds.map(id => criteria.find(c => c.id === id));
        let headerHtml = '<tr>' +
            '<th class="sticky left-0 bg-gray-50 z-10 py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-40 min-w-[160px]">Tên Mẫu</th>' +
            '<th class="sticky left-[160px] bg-gray-50 z-10 py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-32 min-w-[128px]">Số Lô</th>' +
            '<th class="sticky left-[288px] bg-gray-50 z-10 py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-32 min-w-[128px]">Đánh giá</th>' +
            '<th class="sticky left-[416px] bg-gray-50 z-10 py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-48 min-w-[192px]">Ghi chú</th>';

        templateCriteria.forEach(c => {
            headerHtml += `<th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-40 min-w-[160px]">${c.name} (${c.unit})</th>`;
        });
        headerHtml += '<th class="py-3 px-4 w-12 min-w-[48px]"></th></tr>';
        head.innerHTML = headerHtml;

        document.getElementById('report-matrix-body').innerHTML = '';
        addSampleRow();
    }
    
    function getResultInput(criterion) {
        switch (criterion.valueType) {
            case 'numeric': return '<input type="number" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1">';
            case 'pass/fail': return '<select class="w-full pl-2 pr-8 py-1 text-base border-gray-300 sm:text-sm rounded-md"><option>Đạt</option><option>Không đạt</option></select>';
            default: return '<input type="text" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1">';
        }
    }

    function addSampleRow() {
        const body = document.getElementById('report-matrix-body');
        const templateId = parseInt(document.getElementById('report-template-select').value);
        if (!templateId) return;
        const template = templates.find(t => t.id === templateId);
        const templateCriteria = template.criteriaIds.map(id => criteria.find(c => c.id === id));
        const row = document.createElement('tr');
        row.className = "hover:bg-gray-50";

        let rowHtml = 
            '<td class="sticky left-0 bg-white py-2 px-4"><input type="text" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1"></td>' +
            '<td class="sticky left-[160px] bg-white py-2 px-4"><input type="text" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1"></td>' +
            '<td class="sticky left-[288px] bg-white py-2 px-4"><select class="w-full pl-2 pr-8 py-1 text-base border-gray-300 sm:text-sm rounded-md"><option>Đạt</option><option>Không đạt</option></select></td>' +
            '<td class="sticky left-[416px] bg-white py-2 px-4"><input type="text" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1"></td>';

        templateCriteria.forEach(c => { rowHtml += `<td class="py-2 px-4">${getResultInput(c)}</td>`; });
        rowHtml += `<td class="py-2 px-4 text-center"><button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>`;
        
        row.innerHTML = rowHtml;
        body.appendChild(row);
    }
    
    function addMaterialRow() {
        const body = document.getElementById('materials-body');
        const row = document.createElement('tr');
        row.className = "hover:bg-gray-50";
        row.innerHTML = `<td class="py-2 px-4"><input type="text" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1"></td><td class="py-2 px-4"><input type="number" class="w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-1"></td><td class="py-2 px-4 text-center"><button onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>`;
        body.appendChild(row);
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        renderCriteriaTable();
        populateCriteriaForTemplateModal();
        renderTemplates();
        addMaterialRow();
    };
</script>

</body>
</html>


