<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype Quy Trình Phê Duyệt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .tab-button {
            border-color: #d1d5db;
        }
        .level-card {
            transition: all 0.3s ease;
        }
        .approval-status-pending { background-color: #fefce8; border-left-color: #facc15; }
        .approval-status-approved { background-color: #f0fdf4; border-left-color: #4ade80; }
        .approval-status-rejected { background-color: #fef2f2; border-left-color: #f87171; }
        .approval-status-future { background-color: #f9fafb; border-left-color: #9ca3af; }

        /* Tag Input Styles */
        .tag-input-wrapper {
            position: relative;
        }
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
            min-height: 42px;
        }
        .tag-input-container:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .tag-item {
            display: flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #3730a3;
            border-radius: 0.25rem;
            padding: 4px 8px;
            margin: 2px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .tag-remove-btn {
            margin-left: 8px;
            cursor: pointer;
            color: #4f46e5;
        }
        .tag-input-field {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 6px;
            background-color: transparent;
        }
        .suggestions-list {
            position: absolute;
            width: 100%;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            margin-top: 4px;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        
        /* Flowchart styles */
        .flowchart-node {
            position: relative;
            padding-left: 30px; /* Space for icon and line */
        }
        .flowchart-node:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 32px;
            bottom: -16px; /* Connects to the next node */
            width: 2px;
            background-color: #e5e7eb;
        }
        .flowchart-icon {
            position: absolute;
            left: 0;
            top: 6px;
            width: 26px;
            height: 26px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid;
            background-color: white;
        }
        .flowchart-icon.status-future { border-color: #9ca3af; color: #9ca3af; }
        .flowchart-icon.status-pending { border-color: #facc15; color: #facc15; }
        .flowchart-icon.status-approved { border-color: #4ade80; color: #4ade80; }
        .flowchart-icon.status-rejected { border-color: #f87171; color: #f87171; }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Prototype: Quy Trình Phê Duyệt Động</h1>
        <p class="text-gray-600 mb-8">Tạo và quản lý nhiều quy trình, sau đó xem chúng được áp dụng trên một phiếu yêu cầu mẫu.</p>

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button id="tab-creator" class="tab-button active font-semibold whitespace-nowrap py-3 px-4 border-b-2 text-sm">
                    1. Quản Lý Quy Trình
                </button>
                <button id="tab-applicant" class="tab-button font-semibold whitespace-nowrap py-3 px-4 border-b-2 text-sm">
                    2. Áp Dụng trên Phiếu Yêu Cầu (Sample)
                </button>
            </nav>
        </div>

        <!-- Screen 1: Workflow Management -->
        <div id="creator-screen">
            <!-- View 1.1: List of workflows -->
            <div id="workflow-list-view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Danh sách Quy trình Phê duyệt</h2>
                    <button id="show-form-btn" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Tạo Quy trình Mới
                    </button>
                </div>
                <div id="workflow-list-container" class="space-y-3">
                    <!-- Workflow list will be rendered here -->
                </div>
            </div>

            <!-- View 1.2: Form for creating/editing a workflow -->
            <div id="workflow-form-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 id="form-title" class="text-xl font-bold mb-4">Tạo Quy trình Mới</h2>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="workflow-name" class="block text-sm font-medium text-gray-700 mb-1">Tên quy trình (*)</label>
                                <input type="text" id="workflow-name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="VD: Phê duyệt Đơn Mua hàng > 50M">
                            </div>
                            <div>
                                <label for="workflow-model" class="block text-sm font-medium text-gray-700 mb-1">Áp dụng cho phiếu (*)</label>
                                <select id="workflow-model" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="purchase.order">Đơn Mua hàng</option>
                                    <option value="purchase.request">Đề xuất mua hàng</option>
                                    <option value="payment.request">Đề nghị thanh toán</option>
                                </select>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Điều kiện Áp dụng (Tùy chọn)</h3>
                             <p class="text-sm text-gray-500 mb-4">Quy trình sẽ chỉ được kích hoạt nếu bản ghi thỏa mãn điều kiện này.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <label for="condition-field" class="block text-sm font-medium text-gray-700 mb-1">Trường áp dụng</label>
                                    <select id="condition-field" class="w-full p-2 border border-gray-300 rounded-md"></select>
                                </div>
                                <div>
                                    <label for="condition-operator" class="block text-sm font-medium text-gray-700 mb-1">Điều kiện</label>
                                    <select id="condition-operator" class="w-full p-2 border border-gray-300 rounded-md">
                                        <option value=">=">&gt;= (Lớn hơn hoặc bằng)</option>
                                        <option value="<=">&lt;= (Nhỏ hơn hoặc bằng)</option>
                                        <option value=">">&gt; (Lớn hơn)</option>
                                        <option value="<">&lt; (Nhỏ hơn)</option>
                                        <option value="==">= (Bằng)</option>
                                        <option value="!=">!= (Khác)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="condition-value" class="block text-sm font-medium text-gray-700 mb-1">Giá trị</label>
                                    <input type="tel" id="condition-value" class="w-full p-2 border border-gray-300 rounded-md" placeholder="VD: 50,000,000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Các Cấp Phê Duyệt</h3>
                            <div id="levels-container" class="space-y-4"></div>
                            <button id="add-level-btn" class="mt-4 inline-flex items-center px-4 py-2 border border-dashed border-gray-400 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                Thêm Cấp Phê Duyệt
                            </button>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Thông báo khi hoàn thành</h3>
                            <p class="text-sm text-gray-500 mb-4">Những người này sẽ được thông báo. Người tạo phiếu luôn được thông báo mặc định.</p>
                            <div id="notify-wrapper" class="tag-input-wrapper">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Thông báo đến</label>
                                <div class="tag-input-container">
                                    <input type="text" class="tag-input-field" placeholder="Tìm kiếm người dùng hoặc phòng ban...">
                                </div>
                                <div class="suggestions-list hidden"></div>
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 border-t border-gray-200 pt-6">
                             <button id="cancel-btn" class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-100">
                                Hủy bỏ
                            </button>
                            <button id="save-workflow-btn" class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                Lưu Quy Trình
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 2: Workflow Application -->
        <div id="application-screen" class="hidden">
             <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="mb-4">
                     <label for="workflow-selector" class="block text-sm font-medium text-gray-700 mb-1">Chọn quy trình để kiểm tra (test)</label>
                     <select id="workflow-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm"></select>
                </div>

                <div id="approval-view-content" class="hidden">
                    <!-- Top Bar -->
                    <div class="p-4 bg-gray-50 rounded-lg border flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h2 id="applicant-title" class="text-xl font-bold text-gray-900"></h2>
                            <p id="applicant-subtitle" class="text-sm text-gray-600"></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button id="main-reject-btn" class="px-6 py-2.5 text-sm font-semibold rounded-md text-red-700 bg-red-100 hover:bg-red-200">Từ chối</button>
                            <button id="main-approve-btn" class="px-6 py-2.5 text-sm font-semibold rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Duyệt</button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="mt-6 grid grid-cols-10 gap-8">
                        <!-- Left Panel (Content) -->
                        <div class="col-span-10 md:col-span-6">
                            <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Nội dung đề xuất</h3>
                            <div id="request-content-container" class="space-y-4 text-sm">
                                <!-- Sample request content will be rendered here -->
                            </div>
                        </div>
                        <!-- Right Panel (Flowchart) -->
                        <div class="col-span-10 md:col-span-4">
                             <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Quy trình Phê duyệt</h3>
                             <div id="condition-check-container" class="mb-6"></div>
                             <div id="workflow-flowchart-container">
                                <!-- Workflow flowchart will be rendered here -->
                             </div>
                        </div>
                    </div>
                </div>
                <div id="no-workflow-selected" class="text-center py-10">
                    <p class="text-gray-600">Vui lòng chọn một quy trình để kiểm tra.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
      <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">Xác nhận hành động</h3>
          <div class="mt-2 px-7 py-3">
            <p id="modal-description" class="text-sm text-gray-500"></p>
            <textarea id="modal-reason" class="mt-2 w-full p-2 border border-gray-300 rounded-md" rows="3" placeholder="..."></textarea>
            <p id="modal-error" class="text-red-500 text-xs text-left mt-1 hidden">Vui lòng nhập lý do.</p>
          </div>
          <div class="items-center px-4 py-3 bg-gray-50 -mx-5 -mb-5 rounded-b-md">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md mr-2 hover:bg-gray-300">Hủy bỏ</button>
            <button id="modal-confirm-btn" class="px-4 py-2 text-white text-sm font-medium rounded-md">Xác nhận</button>
          </div>
        </div>
      </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- START: Data Simulation ---
        const allUsers = ["Nguyễn Văn A", "Trần Thị B", "Lê Văn C", "Phạm Thị D", "Hoàng Văn E", "Vũ Thị F", "Đặng Văn G", "Bùi Thị H", "Võ Huy Tài", "Duy Phong", "Ngọc Oanh", "Quang Lộc", "Đình Phúc", "Y Đạt"];
        const allDepartments = ["Phòng Kế toán", "Phòng Mua hàng", "Phòng Nhân sự", "Phòng Kinh doanh", "Phòng Kỹ thuật", "Ban Giám đốc", "Kho", "Điện nước", "Sản xuất B5"];
        const allNotifiables = [...new Set([...allUsers, ...allDepartments])]; // Combined list for notifications
        const modelFields = {
            'purchase.order': { 'amount_total': 'Tổng giá trị', 'product_qty': 'Tổng số lượng' },
            'purchase.request': { 'estimated_cost': 'Chi phí dự kiến' },
            'payment.request': { 'amount': 'Số tiền' }
        };
        const sampleRecord = {
            'purchase.order': { 
                id: 'PO/2025/00123', 
                data: { amount_total: 65000000, product_qty: 10 }, 
                content: `
                    <p><strong>Nhà cung cấp:</strong> Công ty TNHH Thiết bị ABC</p>
                    <p><strong>Ngày đặt hàng:</strong> 08/07/2025</p>
                    <table class="w-full mt-4 border-collapse border border-gray-300">
                        <thead><tr class="bg-gray-100"><th class="border p-2 text-left">Sản phẩm</th><th class="border p-2 text-right">Số lượng</th><th class="border p-2 text-right">Đơn giá</th><th class="border p-2 text-right">Thành tiền</th></tr></thead>
                        <tbody>
                            <tr><td class="border p-2">Dây cáp điện Cadivi 2.5</td><td class="border p-2 text-right">500 mét</td><td class="border p-2 text-right">110,000</td><td class="border p-2 text-right">55,000,000</td></tr>
                            <tr><td class="border p-2">Ổ cắm Sino S18</td><td class="border p-2 text-right">100 cái</td><td class="border p-2 text-right">100,000</td><td class="border p-2 text-right">10,000,000</td></tr>
                        </tbody>
                        <tfoot><tr class="font-bold"><td colspan="3" class="border p-2 text-right">Tổng cộng</td><td class="border p-2 text-right">65,000,000</td></tr></tfoot>
                    </table>`
            },
            'purchase.request': { 
                id: 'PR/2025/00089', 
                data: { estimated_cost: 25000000 },
                content: `
                    <p><strong>Người đề xuất:</strong> Nguyễn Văn A</p>
                    <p><strong>Phòng ban:</strong> Phòng Kinh doanh</p>
                    <p><strong>Ngày đề xuất:</strong> 08/07/2025</p>
                    <p><strong>Lý do:</strong> Bổ sung vật tư cho dự án Quý 3/2025.</p>
                    <table class="w-full mt-4 border-collapse border border-gray-300">
                        <thead><tr class="bg-gray-100"><th class="border p-2 text-left">Sản phẩm</th><th class="border p-2 text-right">Số lượng</th><th class="border p-2 text-right">Đơn giá (dự kiến)</th><th class="border p-2 text-right">Thành tiền</th></tr></thead>
                        <tbody>
                            <tr><td class="border p-2">Laptop Dell Vostro</td><td class="border p-2 text-right">1</td><td class="border p-2 text-right">18,000,000</td><td class="border p-2 text-right">18,000,000</td></tr>
                            <tr><td class="border p-2">Màn hình 24" LG</td><td class="border p-2 text-right">2</td><td class="border p-2 text-right">3,500,000</td><td class="border p-2 text-right">7,000,000</td></tr>
                        </tbody>
                        <tfoot><tr class="font-bold"><td colspan="3" class="border p-2 text-right">Tổng chi phí dự kiến</td><td class="border p-2 text-right">25,000,000</td></tr></tfoot>
                    </table>
                `
            },
            'payment.request': { id: 'PAY/2025/00156', data: { amount: 15000000 }, content: `<p>Nội dung chi tiết cho đề nghị thanh toán PAY/2025/00156...</p>` }
        };
        // --- END: Data Simulation ---

        // DOM Elements
        const creatorScreen = document.getElementById('creator-screen');
        const applicationScreen = document.getElementById('application-screen');
        const tabCreator = document.getElementById('tab-creator');
        const tabApplicant = document.getElementById('tab-applicant');
        
        const workflowListView = document.getElementById('workflow-list-view');
        const workflowFormView = document.getElementById('workflow-form-view');
        const workflowListContainer = document.getElementById('workflow-list-container');
        const showFormBtn = document.getElementById('show-form-btn');

        const formTitle = document.getElementById('form-title');
        const workflowNameInput = document.getElementById('workflow-name');
        const workflowModelSelect = document.getElementById('workflow-model');
        const levelsContainer = document.getElementById('levels-container');
        const addLevelBtn = document.getElementById('add-level-btn');
        const saveWorkflowBtn = document.getElementById('save-workflow-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const notifyWrapper = document.getElementById('notify-wrapper');
        
        const conditionFieldSelect = document.getElementById('condition-field');
        const conditionOperatorSelect = document.getElementById('condition-operator');
        const conditionValueInput = document.getElementById('condition-value');

        const workflowSelector = document.getElementById('workflow-selector');
        const approvalViewContent = document.getElementById('approval-view-content');
        const noWorkflowSelected = document.getElementById('no-workflow-selected');
        const applicantTitle = document.getElementById('applicant-title');
        const applicantSubtitle = document.getElementById('applicant-subtitle');
        const conditionCheckContainer = document.getElementById('condition-check-container');
        const requestContentContainer = document.getElementById('request-content-container');
        const workflowFlowchartContainer = document.getElementById('workflow-flowchart-container');
        const mainApproveBtn = document.getElementById('main-approve-btn');
        const mainRejectBtn = document.getElementById('main-reject-btn');
        
        // Modal elements
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalReason = document.getElementById('modal-reason');
        const modalError = document.getElementById('modal-error');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        let levelCounter = 0;
        let currentEditingId = null;
        let currentActionCallback = null;

        const modelNames = {
            'purchase.order': 'Đơn Mua hàng',
            'purchase.request': 'Đề xuất mua hàng',
            'payment.request': 'Đề nghị thanh toán'
        };

        // --- View Management ---
        function showListView() {
            workflowListView.classList.remove('hidden');
            workflowFormView.classList.add('hidden');
            renderWorkflowList();
        }

        function showFormView(workflowId = null) {
            workflowListView.classList.add('hidden');
            workflowFormView.classList.remove('hidden');
            currentEditingId = workflowId;
            levelsContainer.innerHTML = '';
            levelCounter = 0;
            
            // Clear and re-initialize notify input
            notifyWrapper.innerHTML = `
                <label class="block text-sm font-medium text-gray-700 mb-1">Thông báo đến</label>
                <div class="tag-input-container">
                    <input type="text" class="tag-input-field" placeholder="Tìm kiếm người dùng hoặc phòng ban...">
                </div>
                <div class="suggestions-list hidden"></div>
            `;

            if (workflowId) {
                const workflows = getWorkflows();
                const workflow = workflows.find(w => w.id === workflowId);
                formTitle.textContent = "Chỉnh sửa Quy trình";
                workflowNameInput.value = workflow.workflow_name;
                workflowModelSelect.value = workflow.model;
                updateConditionFields(workflow.model);
                if (workflow.condition) {
                    conditionFieldSelect.value = workflow.condition.field;
                    conditionOperatorSelect.value = workflow.condition.operator;
                    conditionValueInput.value = workflow.condition.value.toLocaleString('en-US');
                } else {
                    conditionFieldSelect.value = 'none';
                    conditionValueInput.value = '';
                }
                workflow.levels.forEach(addLevel);
                initializeTagInput(notifyWrapper, allNotifiables, workflow.notify_to || []);
            } else {
                formTitle.textContent = "Tạo Quy trình Mới";
                workflowNameInput.value = '';
                workflowModelSelect.value = 'purchase.order';
                updateConditionFields('purchase.order');
                conditionFieldSelect.value = 'none';
                conditionValueInput.value = '';
                addLevel(); // Start with one level
                initializeTagInput(notifyWrapper, allNotifiables, []);
            }
        }
        
        function updateConditionFields(modelKey) {
            conditionFieldSelect.innerHTML = '<option value="none">-- Không áp dụng --</option>';
            const fields = modelFields[modelKey];
            for (const key in fields) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = fields[key];
                conditionFieldSelect.appendChild(option);
            }
        }

        // --- Data Handling ---
        function getWorkflows() {
            return JSON.parse(localStorage.getItem('approvalWorkflows')) || [];
        }

        function saveWorkflows(workflows) {
            localStorage.setItem('approvalWorkflows', JSON.stringify(workflows));
        }
        
        function generateSampleData() {
            const sampleWorkflows = [
                {
                    id: 'sample1', active: true, workflow_name: 'QT Phê duyệt cho Kho', model: 'purchase.request',
                    condition: null, notify_to: ['Phòng Kế toán'],
                    levels: [
                        { name: 'Chủ quản trực tiếp', approver_type: 'user', approvers: ['Ngọc Oanh'], approval_mode: 'all' },
                        { name: 'Phó TGĐ (Kho & KD)', approver_type: 'user', approvers: ['Quang Lộc'], approval_mode: 'all' },
                        { name: 'P.TGĐ HCQT', approver_type: 'user', approvers: ['Y Đạt'], approval_mode: 'all' }
                    ]
                },
                {
                    id: 'sample2', active: true, workflow_name: 'QT Phê duyệt Điện nước (>20M)', model: 'purchase.order',
                    condition: { field: 'amount_total', operator: '>=', value: 20000000 }, notify_to: ['Phòng Kế toán'],
                    levels: [
                        { name: 'Chủ quản trực tiếp', approver_type: 'user', approvers: ['Võ Huy Tài'], approval_mode: 'all' },
                        { name: 'Phó TGĐ (Khối SX)', approver_type: 'user', approvers: ['Đình Phúc'], approval_mode: 'all' },
                        { name: 'P.TGĐ HCQT', approver_type: 'user', approvers: ['Y Đạt'], approval_mode: 'all' }
                    ]
                },
                {
                    id: 'sample3', active: false, workflow_name: 'QT Phê duyệt Sản xuất B5 (2 cấp)', model: 'purchase.request',
                    condition: null, notify_to: [],
                    levels: [
                        { name: 'TP. Sản xuất B5', approver_type: 'user', approvers: ['Duy Phong'], approval_mode: 'all' },
                        { name: 'P.TGĐ HCQT', approver_type: 'user', approvers: ['Y Đạt'], approval_mode: 'all' }
                    ]
                },
                {
                    id: 'sample4', active: true, workflow_name: 'QT Thanh toán Marketing (< 10M)', model: 'payment.request',
                    condition: { field: 'amount', operator: '<', value: 10000000 }, notify_to: ['Phòng Marketing'],
                    levels: [
                        { name: 'Trưởng phòng Marketing', approver_type: 'job_position', approvers: ['Phòng Kinh doanh'], approval_mode: 'all' },
                        { name: 'Kế toán trưởng', approver_type: 'job_position', approvers: ['Phòng Kế toán'], approval_mode: 'all' }
                    ]
                },
                {
                    id: 'sample5', active: true, workflow_name: 'QT Mua hàng (Bất kỳ GĐ duyệt)', model: 'purchase.order',
                    condition: null, notify_to: ['Phòng Kinh doanh', 'Phòng Kế toán'],
                    levels: [
                        { name: 'Ban Giám đốc', approver_type: 'user', approvers: ['Quang Lộc', 'Đình Phúc', 'Y Đạt'], approval_mode: 'any' }
                    ]
                },
                {
                    id: 'sample6', active: true, workflow_name: 'QT Mua sắm IT (đa duyệt)', model: 'purchase.request',
                    condition: null, notify_to: [],
                    levels: [
                        { name: 'Trưởng phòng IT & Chủ quản', approver_type: 'user', approvers: ['Võ Huy Tài', 'Ngọc Oanh'], approval_mode: 'all' },
                        { name: 'Phó TGĐ (Khối SX)', approver_type: 'user', approvers: ['Đình Phúc'], approval_mode: 'all' },
                        { name: 'P.TGĐ HCQT', approver_type: 'user', approvers: ['Y Đạt'], approval_mode: 'all' }
                    ]
                },
                {
                    id: 'sample7', active: true, workflow_name: 'QT Nhân sự (tỷ lệ)', model: 'payment.request',
                    condition: null, notify_to: [],
                    levels: [
                        { name: 'Hội đồng nhân sự', approver_type: 'user', approvers: ['Trần Thị B', 'Lê Văn C', 'Phạm Thị D'], approval_mode: 'percentage', required_percentage: 67 },
                        { name: 'P.TGĐ HCQT', approver_type: 'user', approvers: ['Y Đạt'], approval_mode: 'all' }
                    ]
                }
            ];
            saveWorkflows(sampleWorkflows);
        }

        // --- Core Functions ---
        function renderWorkflowList() {
            const workflows = getWorkflows();
            workflowListContainer.innerHTML = '';
            if (workflows.length === 0) {
                workflowListContainer.innerHTML = `<div class="text-center p-8 border-2 border-dashed rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800">Chưa có quy trình nào.</h3>
                    <p class="mt-1 text-sm text-gray-500">Hãy nhấn "Tạo Quy trình Mới" để bắt đầu.</p>
                </div>`;
                return;
            }

            workflows.forEach(w => {
                let conditionText = 'Không có';
                if (w.condition) {
                    const fieldName = modelFields[w.model]?.[w.condition.field] || w.condition.field;
                    const formattedValue = w.condition.value.toLocaleString('en-US');
                    conditionText = `${fieldName} ${w.condition.operator} ${formattedValue}`;
                }
                const notifyText = w.notify_to && w.notify_to.length > 0 ? w.notify_to.join(', ') : 'Không có';

                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-lg shadow-sm border';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-3 flex-wrap">
                             <p class="font-bold text-indigo-700">${w.workflow_name}</p>
                             <span class="text-xs font-medium px-2 py-0.5 rounded-full ${w.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${w.active ? 'Hoạt động' : 'Không hoạt động'}
                            </span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="relative inline-flex items-center cursor-pointer" title="Bật/Tắt quy trình">
                              <input type="checkbox" class="sr-only peer status-toggle" ${w.active ? 'checked' : ''} data-id="${w.id}">
                              <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-indigo-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                            <button class="edit-btn p-1 text-gray-500 hover:text-indigo-600" data-id="${w.id}" title="Sửa">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                            </button>
                            <button class="delete-btn p-1 text-gray-500 hover:text-red-600" data-id="${w.id}" title="Xóa">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Áp dụng cho: <b>${modelNames[w.model]}</b> | ${w.levels.length} cấp duyệt</p>
                    <p class="text-sm text-gray-500 mt-1">Điều kiện: <span class="font-mono text-xs bg-gray-100 p-1 rounded">${conditionText}</span></p>
                    <p class="text-sm text-gray-500 mt-1">Thông báo: <span class="text-xs italic">${notifyText}</span></p>
                `;
                workflowListContainer.appendChild(item);
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => showFormView(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteWorkflow(e.currentTarget.dataset.id)));
            document.querySelectorAll('.status-toggle').forEach(toggle => toggle.addEventListener('change', (e) => toggleWorkflowStatus(e.target.dataset.id, e.target.checked)));
        }

        function addLevel(levelData = {}) {
            levelCounter++;
            const levelId = `level-${levelCounter}`;
            const levelCard = document.createElement('div');
            levelCard.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 level-card';
            levelCard.id = levelId;
            
            const approverType = levelData.approver_type || 'user';
            const requiredPercentage = levelData.approval_mode === 'percentage' ? (levelData.required_percentage || '50') : '50';
            const percentageDisplay = levelData.approval_mode === 'percentage' ? 'block' : 'none';

            levelCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-semibold text-md text-indigo-700">Cấp ${levelCounter}</p>
                    <button type="button" class="text-gray-400 hover:text-red-600" onclick="document.getElementById('${levelId}').remove()">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tên cấp duyệt (*)</label>
                        <input type="text" name="level-name" class="mt-1 w-full p-2 border border-gray-300 rounded-md" value="${levelData.name || ''}" placeholder="VD: Trưởng phòng duyệt">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Chỉ định phê duyệt (*)</label>
                        <select name="approver-type" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            <option value="user" ${approverType === 'user' ? 'selected' : ''}>Cố định người phê duyệt</option>
                            <option value="job_position" ${approverType === 'job_position' ? 'selected' : ''}>Phòng ban phê duyệt</option>
                        </select>
                        <p name="approver-type-hint" class="mt-1 text-xs text-gray-500"></p>
                    </div>
                    <div name="by-name-wrapper" class="tag-input-wrapper">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên người duyệt (*)</label>
                        <div class="tag-input-container">
                            <input type="text" class="tag-input-field" placeholder="Tìm kiếm người duyệt...">
                        </div>
                        <div class="suggestions-list hidden"></div>
                    </div>
                     <div name="by-job-wrapper" class="tag-input-wrapper">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên phòng ban (*)</label>
                        <div class="tag-input-container">
                             <input type="text" class="tag-input-field" placeholder="Tìm kiếm phòng ban...">
                        </div>
                        <div class="suggestions-list hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Điều kiện duyệt (*)</label>
                        <select name="approval-mode" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            <option value="all" ${levelData.approval_mode === 'all' ? 'selected' : ''}>Tất cả (All)</option>
                            <option value="any" ${levelData.approval_mode === 'any' ? 'selected' : ''}>Bất kỳ (Any)</option>
                            <option value="percentage" ${levelData.approval_mode === 'percentage' ? 'selected' : ''}>Theo tỷ lệ (%)</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500"><b>All:</b> 100% người được chỉ định phải duyệt.<br><b>Any:</b> Chỉ cần 1 người duyệt là đủ.<br><b>Percentage:</b> Đạt một tỷ lệ % người duyệt.</p>
                    </div>
                    <div name="percentage-wrapper" style="display: ${percentageDisplay};">
                        <label class="block text-sm font-medium text-gray-700">Tỷ lệ yêu cầu (%)</label>
                        <input type="number" name="required-percentage" class="mt-1 w-full p-2 border border-gray-300 rounded-md" value="${requiredPercentage}" min="1" max="100">
                    </div>
                </div>
            `;
            levelsContainer.appendChild(levelCard);
            
            initializeTagInput(levelCard.querySelector('div[name="by-name-wrapper"]'), allUsers, levelData.approver_type === 'user' ? levelData.approvers : []);
            initializeTagInput(levelCard.querySelector('div[name="by-job-wrapper"]'), allDepartments, levelData.approver_type === 'job_position' ? levelData.approvers : []);

            const approverTypeSelect = levelCard.querySelector('select[name="approver-type"]');
            const approverTypeHint = levelCard.querySelector('p[name="approver-type-hint"]');
            const byNameWrapper = levelCard.querySelector('div[name="by-name-wrapper"]');
            const byJobWrapper = levelCard.querySelector('div[name="by-job-wrapper"]');
            
            const updateApproverUI = (selectedValue) => {
                if (selectedValue === 'user') {
                    approverTypeHint.textContent = 'Chỉ định một hoặc nhiều người dùng cụ thể, cố định.';
                    byNameWrapper.style.display = 'block';
                    byJobWrapper.style.display = 'none';
                } else {
                    approverTypeHint.textContent = 'Chọn các phòng ban, và người duyệt sẽ là Trưởng phòng của các phòng ban đó.';
                    byNameWrapper.style.display = 'none';
                    byJobWrapper.style.display = 'block';
                }
            };

            approverTypeSelect.addEventListener('change', (e) => updateApproverUI(e.target.value));
            updateApproverUI(approverTypeSelect.value);

            levelCard.querySelector('select[name="approval-mode"]').addEventListener('change', (e) => {
                const percentageWrapper = levelCard.querySelector('div[name="percentage-wrapper"]');
                percentageWrapper.style.display = e.target.value === 'percentage' ? 'block' : 'none';
            });
        }
        
        function initializeTagInput(wrapper, dataSource, initialTags = []) {
            const container = wrapper.querySelector('.tag-input-container');
            const input = wrapper.querySelector('.tag-input-field');
            const suggestionsList = wrapper.querySelector('.suggestions-list');
            let tags = [];

            const addTag = (value) => {
                if (value && !tags.includes(value)) {
                    tags.push(value);
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag-item';
                    tagEl.innerHTML = `${value}<span class="tag-remove-btn" data-value="${value}">&times;</span>`;
                    container.insertBefore(tagEl, input);
                    input.value = '';
                    suggestionsList.classList.add('hidden');

                    tagEl.querySelector('.tag-remove-btn').addEventListener('click', (e) => {
                        const valToRemove = e.target.getAttribute('data-value');
                        tags = tags.filter(t => t !== valToRemove);
                        e.target.parentElement.remove();
                    });
                }
            };
            
            initialTags.forEach(addTag);
            wrapper.getTags = () => tags;

            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                if (query.length === 0) {
                    suggestionsList.classList.add('hidden');
                    return;
                }
                const filteredData = dataSource.filter(item => 
                    item.toLowerCase().includes(query) && !tags.includes(item)
                );
                suggestionsList.innerHTML = '';
                if (filteredData.length > 0) {
                    filteredData.forEach(item => {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'suggestion-item';
                        suggestionEl.textContent = item;
                        suggestionEl.addEventListener('click', () => addTag(item));
                        suggestionsList.appendChild(suggestionEl);
                    });
                    suggestionsList.classList.remove('hidden');
                } else {
                    suggestionsList.classList.add('hidden');
                }
            });
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value) {
                    e.preventDefault();
                    addTag(input.value);
                } else if (e.key === 'Backspace' && input.value === '' && tags.length > 0) {
                    tags.pop();
                    container.querySelector('.tag-item:last-of-type')?.remove();
                }
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    suggestionsList.classList.add('hidden');
                }
            });
        }

        function saveWorkflow() {
            const workflowName = workflowNameInput.value.trim();
            if (!workflowName) {
                alert('Vui lòng nhập tên quy trình.');
                return;
            }

            const levels = [];
            const levelCards = levelsContainer.querySelectorAll('.level-card');
            
            for (let i = 0; i < levelCards.length; i++) {
                const card = levelCards[i];
                const name = card.querySelector('input[name="level-name"]').value.trim();
                const approver_type = card.querySelector('select[name="approver-type"]').value;
                const approvers = approver_type === 'user' 
                    ? card.querySelector('div[name="by-name-wrapper"]').getTags()
                    : card.querySelector('div[name="by-job-wrapper"]').getTags();

                const approval_mode = card.querySelector('select[name="approval-mode"]').value;
                const required_percentage = card.querySelector('input[name="required-percentage"]').value;

                if (!name || approvers.length === 0) {
                    alert(`Vui lòng điền đầy đủ thông tin cho Cấp ${i + 1}.`);
                    return;
                }

                levels.push({
                    sequence: (i + 1) * 10, name, approver_type, approvers, approval_mode,
                    required_percentage: approval_mode === 'percentage' ? parseFloat(required_percentage) : null,
                });
            }

            if (levels.length === 0) {
                alert('Quy trình phải có ít nhất một cấp phê duyệt.');
                return;
            }
            
            const notifyToList = notifyWrapper.getTags();

            const newWorkflow = { 
                workflow_name: workflowName, 
                model: workflowModelSelect.value, 
                levels: levels,
                condition: null,
                notify_to: notifyToList
            };
            
            const conditionField = conditionFieldSelect.value;
            if (conditionField !== 'none') {
                const conditionValue = conditionValueInput.value;
                if (conditionValue.trim() !== '') {
                    const rawValue = conditionValue.replace(/[^0-9]/g, '');
                    newWorkflow.condition = {
                        field: conditionField,
                        operator: conditionOperatorSelect.value,
                        value: parseFloat(rawValue)
                    };
                }
            }

            let workflows = getWorkflows();
            if (currentEditingId) {
                const index = workflows.findIndex(w => w.id === currentEditingId);
                newWorkflow.active = workflows[index].active; // Preserve active status
                workflows[index] = { id: currentEditingId, ...newWorkflow };
            } else {
                newWorkflow.id = Date.now().toString();
                newWorkflow.active = true; // Default to active for new workflows
                workflows.push(newWorkflow);
            }
            
            saveWorkflows(workflows);
            alert('Quy trình đã được lưu thành công!');
            showListView();
        }

        function deleteWorkflow(id) {
            if (confirm('Bạn có chắc muốn xóa quy trình này?')) {
                let workflows = getWorkflows();
                workflows = workflows.filter(w => w.id !== id);
                saveWorkflows(workflows);
                renderWorkflowList();
            }
        }
        
        function toggleWorkflowStatus(id, isActive) {
            let workflows = getWorkflows();
            const index = workflows.findIndex(w => w.id === id);
            if (index !== -1) {
                workflows[index].active = isActive;
                saveWorkflows(workflows);
                renderWorkflowList();
            }
        }
        
        function showConfirmationModal(action, callback) {
            currentActionCallback = callback;
            modalReason.classList.remove('border-red-500');
            modalError.classList.add('hidden');

            if (action === 'reject') {
                modalTitle.textContent = 'Xác nhận Từ chối';
                modalDescription.textContent = 'Vui lòng nhập lý do từ chối.';
                modalReason.required = true;
                modalReason.placeholder = 'Lý do từ chối (bắt buộc)...';
                modalConfirmBtn.className = 'px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700';
            } else {
                modalTitle.textContent = 'Xác nhận Phê duyệt';
                modalDescription.textContent = 'Bạn có thể nhập ghi chú hoặc chỉ đạo (tùy chọn).';
                modalReason.required = false;
                modalReason.placeholder = 'Ghi chú (tùy chọn)...';
                modalConfirmBtn.className = 'px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700';
            }
            modalReason.value = '';
            modal.classList.remove('hidden');
        }

        function renderApplicantView(workflowId) {
            const workflows = getWorkflows();
            const activeWorkflows = workflows.filter(w => w.active);

            if (activeWorkflows.length === 0) {
                noWorkflowSelected.innerHTML = `<div class="text-center p-8 border-2 border-dashed rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800">Không có quy trình nào đang hoạt động.</h3>
                    <p class="mt-1 text-sm text-gray-500">Vui lòng quay lại tab "Quản lý Quy trình" để kích hoạt hoặc tạo mới.</p>
                </div>`;
                noWorkflowSelected.classList.remove('hidden');
                approvalViewContent.classList.add('hidden');
                return;
            }
            
            const selectedId = workflowId || workflowSelector.value;
            const workflow = activeWorkflows.find(w => w.id === selectedId);
            
            if (!workflow) {
                noWorkflowSelected.classList.remove('hidden');
                approvalViewContent.classList.add('hidden');
                return;
            }
            
            noWorkflowSelected.classList.add('hidden');
            approvalViewContent.classList.remove('hidden');

            const record = sampleRecord[workflow.model];
            applicantTitle.textContent = `${modelNames[workflow.model]}: ${record.id}`;
            const subtitleData = Object.entries(record.data).map(([key, val]) => `${modelFields[workflow.model][key]}: ${val.toLocaleString('en-US')}`).join(' | ');
            applicantSubtitle.textContent = `Người yêu cầu: Nguyễn Văn A | ${subtitleData}`;
            requestContentContainer.innerHTML = record.content;
            
            let conditionMet = true;
            if (workflow.condition) {
                const { field, operator, value } = workflow.condition;
                const recordValue = record.data[field];
                
                switch(operator) {
                    case '>=': conditionMet = recordValue >= value; break;
                    case '<=': conditionMet = recordValue <= value; break;
                    case '>': conditionMet = recordValue > value; break;
                    case '<': conditionMet = recordValue < value; break;
                    case '==': conditionMet = recordValue == value; break;
                    case '!=': conditionMet = recordValue != value; break;
                }
                
                const fieldName = modelFields[workflow.model][field];
                const resultText = conditionMet ? 'Thỏa mãn' : 'Không thỏa mãn';
                const resultColor = conditionMet ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';

                conditionCheckContainer.innerHTML = `
                    <div class="p-3 rounded-lg ${resultColor}">
                        <p class="font-semibold">Kiểm tra điều kiện: <span class="font-bold">${resultText}</span></p>
                        <p class="text-sm">Quy trình yêu cầu: <span class="font-mono text-xs bg-white p-1 rounded">${fieldName} ${operator} ${value.toLocaleString('en-US')}</span></p>
                        <p class="text-sm">Dữ liệu thực tế: <span class="font-mono text-xs bg-white p-1 rounded">${fieldName} = ${recordValue.toLocaleString('en-US')}</span></p>
                    </div>
                `;
            } else {
                conditionCheckContainer.innerHTML = `
                    <div class="p-3 rounded-lg text-blue-600 bg-blue-100">
                        <p class="font-semibold">Quy trình này không có điều kiện áp dụng.</p>
                    </div>
                `;
            }

            if (!conditionMet) {
                workflowFlowchartContainer.innerHTML = `<div class="text-center p-8 border-2 border-dashed rounded-lg border-yellow-400 bg-yellow-50">
                    <h3 class="text-lg font-medium text-yellow-800">Quy trình không được áp dụng.</h3>
                    <p class="mt-1 text-sm text-yellow-700">Bản ghi không thỏa mãn điều kiện đã được cấu hình.</p>
                </div>`;
                mainApproveBtn.disabled = true;
                mainRejectBtn.disabled = true;
                return;
            }
            
            mainApproveBtn.disabled = false;
            mainRejectBtn.disabled = false;

            const simulationWorkflow = JSON.parse(JSON.stringify(workflow));
            simulationWorkflow.levels.forEach(level => {
                level.status = 'future';
                level.approved_by = [];
                level.rejected_by = [];
                level.skipped_by = [];
                level.comments = {};
            });
            if (simulationWorkflow.levels.length > 0) {
                simulationWorkflow.levels[0].status = 'pending';
            }
            window.simulationState = simulationWorkflow;
            renderSimulationFromState(simulationWorkflow);
        }

        function processApproval(levelIndex, approver, action, reason) {
            const simulationWorkflow = window.simulationState;
            if (!simulationWorkflow) return;
            
            const level = simulationWorkflow.levels[levelIndex];
            
            if (level.status === 'approved' || level.status === 'rejected') return;

            if (reason) {
                level.comments[approver] = reason;
            }

            if (action === 'reject') {
                if (!level.rejected_by.includes(approver)) level.rejected_by.push(approver);
                level.status = 'rejected';
                renderSimulationFromState(simulationWorkflow);
                const notificationList = 'Người tạo phiếu (Nguyễn Văn A)';
                setTimeout(() => alert(`Quy trình đã bị TỪ CHỐI.\n\nĐã gửi thông báo đến: ${notificationList}`), 100);
                return;
            }
            
            if (action === 'approve') {
                if (!level.approved_by.includes(approver)) level.approved_by.push(approver);
            }

            let isCompleted = false;
            const totalApprovers = level.approvers.length;
            const approvedCount = level.approved_by.length;

            switch(level.approval_mode) {
                case 'any': 
                    if (approvedCount >= 1) isCompleted = true; 
                    break;
                case 'all': 
                    if (approvedCount === totalApprovers) isCompleted = true; 
                    break;
                case 'percentage':
                    if ((approvedCount / totalApprovers) * 100 >= level.required_percentage) isCompleted = true;
                    break;
            }

            if (isCompleted) {
                level.status = 'approved';
                if (level.approval_mode === 'any') {
                    level.approvers.forEach(a => {
                        if (!level.approved_by.includes(a)) {
                            level.skipped_by.push(a);
                        }
                    });
                }

                if (simulationWorkflow.levels[levelIndex + 1]) {
                    simulationWorkflow.levels[levelIndex + 1].status = 'pending';
                } else {
                    const notificationList = ['Người tạo phiếu (Nguyễn Văn A)', ...(simulationWorkflow.notify_to || [])].join(', ');
                    setTimeout(() => alert(`Quy trình đã được PHÊ DUYỆT hoàn tất!\n\nĐã gửi thông báo đến: ${notificationList}`), 100);
                }
            }
            renderSimulationFromState(simulationWorkflow);
        }

        window.promptForApproval = function(levelIndex, approver, action) {
            showConfirmationModal(action, (reason) => {
                processApproval(levelIndex, approver, action, reason);
            });
        }
        
        function renderSimulationFromState(simulationWorkflow) {
            let html = '<div class="space-y-4">';
            let isAnyLevelPending = false;
            simulationWorkflow.levels.forEach((level, index) => {
                 let statusClass = '', statusText = '';
                 let iconHtml = '';
                switch(level.status) {
                    case 'pending': 
                        statusClass = 'status-pending'; statusText = 'Đang chờ duyệt'; isAnyLevelPending = true;
                        iconHtml = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                        break;
                    case 'approved': 
                        statusClass = 'status-approved'; statusText = 'Đã phê duyệt';
                        iconHtml = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
                        break;
                    case 'rejected': 
                        statusClass = 'status-rejected'; statusText = 'Đã từ chối';
                        iconHtml = `<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                        break;
                    default: 
                        statusClass = 'status-future'; statusText = 'Chưa tới lượt';
                        iconHtml = `<span class="text-xs font-bold">${index + 1}</span>`;
                }
                 let conditionText = '';
                switch(level.approval_mode) {
                    case 'all': conditionText = 'Tất cả'; break;
                    case 'any': conditionText = 'Bất kỳ'; break;
                    case 'percentage': conditionText = `${level.required_percentage}%`; break;
                }
                 html += `<div class="flowchart-node" data-level-index="${index}">
                            <div class="flowchart-icon ${statusClass}">${iconHtml}</div>
                            <div class="p-3 rounded-lg border bg-white">
                                <div class="flex justify-between items-center">
                                    <p class="font-bold text-gray-800">${level.name}</p>
                                    <span class="text-xs font-bold uppercase px-2 py-1 rounded-full ${statusClass.replace('status-', 'approval-status-')}">${statusText}</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">Điều kiện: ${conditionText}</p>
                                <div class="mt-3 space-y-2">`;
                const approverList = level.approver_type === 'job_position' ? level.approvers.map(dept => `Trưởng phòng ${dept}`) : level.approvers;
                approverList.forEach(approver => {
                    const originalApproverName = level.approver_type === 'job_position' ? level.approvers[approverList.indexOf(approver)] : approver;
                    const hasApproved = level.approved_by.includes(originalApproverName);
                    const hasRejected = level.rejected_by.includes(originalApproverName);
                    const hasSkipped = level.skipped_by.includes(originalApproverName);
                    const comment = level.comments?.[originalApproverName];

                    let approverStatus = 'Chờ duyệt', approverStatusColor = 'text-gray-500';
                    if (hasApproved) { approverStatus = 'Đã duyệt'; approverStatusColor = 'text-green-600'; } 
                    else if (hasRejected) { approverStatus = 'Đã từ chối'; approverStatusColor = 'text-red-600'; }
                    else if (hasSkipped) { approverStatus = 'Đã bỏ qua'; approverStatusColor = 'text-gray-400'; }

                     html += `<div class="p-2 bg-gray-50 rounded-md border">
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <div class="flex items-center flex-grow min-w-0">
                                    <span class="h-7 w-7 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600 mr-2 flex-shrink-0">${approver.charAt(0).toUpperCase()}</span>
                                    <div class="min-w-0">
                                        <p class="font-medium text-sm truncate">${approver}</p>
                                        <p class="text-xs ${approverStatusColor}">${approverStatus}</p>
                                    </div>
                                </div>
                                ${level.status === 'pending' && !hasApproved && !hasRejected && !hasSkipped ? `
                                <div class="space-x-1 flex-shrink-0">
                                    <button class="px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700" onclick="promptForApproval(${index}, '${originalApproverName}', 'approve')">Duyệt</button>
                                    <button class="px-2 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700" onclick="promptForApproval(${index}, '${originalApproverName}', 'reject')">Từ chối</button>
                                </div>` : ''}
                            </div>
                            ${comment ? `<div class="mt-2 pt-2 border-t border-dashed text-xs text-gray-600 italic">“${comment}”</div>` : ''}
                        </div>`;
                });
                html += `</div></div></div>`;
            });
            html += '</div>';
            workflowFlowchartContainer.innerHTML = html;
            
            mainApproveBtn.disabled = !isAnyLevelPending;
            mainRejectBtn.disabled = !isAnyLevelPending;
        }

        function populateWorkflowSelector() {
            const workflows = getWorkflows();
            const activeWorkflows = workflows.filter(w => w.active);
            workflowSelector.innerHTML = '<option value="">-- Chọn quy trình --</option>';
            if (activeWorkflows.length > 0) {
                activeWorkflows.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.id;
                    option.textContent = w.workflow_name;
                    workflowSelector.appendChild(option);
                });
            }
        }
        
        function switchTab(tab) {
            if (tab === 'creator') {
                creatorScreen.classList.remove('hidden');
                applicationScreen.classList.add('hidden');
                tabCreator.classList.add('active');
                tabApplicant.classList.remove('active');
                showListView();
            } else {
                creatorScreen.classList.add('hidden');
                applicationScreen.classList.remove('hidden');
                tabCreator.classList.remove('active');
                tabApplicant.classList.add('active');
                populateWorkflowSelector();
                window.simulationState = null; 
                renderApplicantView();
            }
        }
        
        // Event Listeners
        showFormBtn.addEventListener('click', () => showFormView());
        cancelBtn.addEventListener('click', showListView);
        addLevelBtn.addEventListener('click', () => addLevel());
        saveWorkflowBtn.addEventListener('click', saveWorkflow);
        tabCreator.addEventListener('click', () => switchTab('creator'));
        tabApplicant.addEventListener('click', () => switchTab('applicant'));
        workflowModelSelect.addEventListener('change', (e) => updateConditionFields(e.target.value));
        workflowSelector.addEventListener('change', () => {
            window.simulationState = null;
            renderApplicantView();
        });
        conditionValueInput.addEventListener('input', (e) => {
            let rawValue = e.target.value.replace(/[^0-9]/g, '');
            if (rawValue) {
                const formattedValue = parseInt(rawValue, 10).toLocaleString('en-US');
                e.target.value = formattedValue;
            } else {
                e.target.value = '';
            }
        });
        mainApproveBtn.addEventListener('click', () => {
            const simulationWorkflow = window.simulationState;
            if (!simulationWorkflow) return;
            const pendingLevel = simulationWorkflow.levels.find(l => l.status === 'pending');
            if(pendingLevel) {
                const levelIndex = simulationWorkflow.levels.indexOf(pendingLevel);
                const firstAvailableApprover = pendingLevel.approvers.find(a => 
                    !pendingLevel.approved_by.includes(a) && 
                    !pendingLevel.rejected_by.includes(a) &&
                    !pendingLevel.skipped_by.includes(a)
                );
                if(firstAvailableApprover) {
                    promptForApproval(levelIndex, firstAvailableApprover, 'approve');
                }
            }
        });
        mainRejectBtn.addEventListener('click', () => {
            const simulationWorkflow = window.simulationState;
            if (!simulationWorkflow) return;
            const pendingLevel = simulationWorkflow.levels.find(l => l.status === 'pending');
            if(pendingLevel) {
                const levelIndex = simulationWorkflow.levels.indexOf(pendingLevel);
                const firstAvailableApprover = pendingLevel.approvers.find(a => 
                    !pendingLevel.approved_by.includes(a) && 
                    !pendingLevel.rejected_by.includes(a) &&
                    !pendingLevel.skipped_by.includes(a)
                );
                if(firstAvailableApprover) {
                    promptForApproval(levelIndex, firstAvailableApprover, 'reject');
                }
            }
        });
        
        // Modal Listeners
        modalCancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modalConfirmBtn.addEventListener('click', () => {
            const reason = modalReason.value.trim();
            if(modalReason.required && !reason) {
                modalReason.classList.add('border-red-500');
                modalError.classList.remove('hidden');
                return;
            }
            if(currentActionCallback) {
                currentActionCallback(reason);
            }
            modal.classList.add('hidden');
            currentActionCallback = null;
        });
        modalReason.addEventListener('input', () => {
            if (modalReason.classList.contains('border-red-500')) {
                modalReason.classList.remove('border-red-500');
                modalError.classList.add('hidden');
            }
        });


        // Initial Load
        if (getWorkflows().length === 0) {
            generateSampleData();
        }
        showListView();
    });
    </script>
</body>
</html>
